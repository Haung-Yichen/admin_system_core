<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>驗證中 - {{APP_NAME}}</title>

    <!-- LIFF SDK (Official CDN) - Must load before app script -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'line-green': '#06C755',
                        'line-green-dark': '#05B34C',
                        'primary': '#1A1A2E',
                        'error-red': '#E74C3C',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Custom spinner animation */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success checkmark animation */
        @keyframes checkmark {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        .checkmark-animated {
            animation: checkmark 0.5s ease-out forwards;
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* State visibility */
        .state-hidden {
            display: none !important;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50 flex items-center justify-content-center p-4">

    <div class="bg-white rounded-2xl shadow-lg max-w-md w-full mx-auto overflow-hidden">

        <div class="p-10 text-center">

            <!-- Loading State -->
            <div id="state-loading" class="state-container">
                <div class="w-14 h-14 border-4 border-gray-200 border-t-line-green rounded-full spinner mx-auto mb-6"></div>
                <h1 class="text-xl font-semibold text-gray-800 mb-3">驗證中...</h1>
                <p class="text-gray-500">請稍候，正在驗證您的請求</p>
            </div>

            <!-- Success State -->
            <div id="state-success" class="state-container state-hidden">
                <div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-line-green checkmark-animated" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h1 class="text-xl font-semibold text-gray-800 mb-3">驗證成功！</h1>
                <p class="text-gray-500 mb-2">您的 LINE 帳號已成功綁定</p>
                <p id="success-hint" class="text-sm text-gray-400">視窗即將自動關閉...</p>
                
                <button id="close-btn" 
                        onclick="closeWindow()"
                        class="state-hidden mt-6 px-8 py-3 bg-line-green hover:bg-line-green-dark text-white font-medium rounded-full transition-colors">
                    關閉視窗
                </button>
            </div>

            <!-- Error State -->
            <div id="state-error" class="state-container state-hidden">
                <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-error-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                <h1 class="text-xl font-semibold text-gray-800 mb-3">驗證失敗</h1>
                <p id="error-message" class="text-gray-500 mb-2">請重新嘗試或聯繫管理員</p>
                
                <div id="error-detail" class="state-hidden mt-4 p-3 bg-red-50 rounded-lg">
                    <p id="error-detail-text" class="text-sm text-error-red break-words"></p>
                </div>
                
                <button onclick="closeWindow()"
                        class="mt-6 px-8 py-3 bg-gray-700 hover:bg-gray-800 text-white font-medium rounded-full transition-colors">
                    關閉視窗
                </button>
            </div>

        </div>

        <!-- Footer -->
        <div class="px-10 pb-6 text-center">
            <p class="text-xs text-gray-400">{{APP_NAME}}</p>
        </div>

    </div>

    <script>
        /**
         * Framework-First Authentication - Verify Result Page
         * 
         * Architecture: UI State Locking + Fire-and-Forget LIFF
         * 
         * Key Principles:
         * 1. UI State Locking: Loading state is LOCKED until API responds
         * 2. API First: ONLY verifyToken() can change UI state
         * 3. Background LIFF: liff.init() runs fire-and-forget, never blocks UI
         * 4. Execution Guard: Prevents duplicate main() execution
         * 
         * Flow:
         * 1. Extract token from URL (BEFORE LIFF can modify URL)
         * 2. Start LIFF init in background (fire-and-forget)
         * 3. Call /auth/api/verify to verify token
         * 4. Show success/error based on API response
         * 5. Auto-close if in LIFF client, otherwise show manual close button
         */

        // ============================================
        // IMMEDIATE EXECUTION - Lock Loading State
        // ============================================
        document.title = '驗證中...';

        // Execution guard - prevent duplicate runs
        if (window.hasRun) {
            console.warn('main() already executed, skipping duplicate run');
        }

        // ============================================
        // Configuration (Injected by Backend)
        // ============================================
        const CONFIG = {
            liffId: '{{LIFF_ID}}',
            appContext: '{{APP_CONTEXT}}',
            appName: '{{APP_NAME}}',
            apiEndpoint: '/auth/api/verify',
            closeDelayMs: 2000
        };

        // ============================================
        // Global State
        // ============================================
        let isLiffReady = false;
        let liffInitPromise = null;

        // ============================================
        // DOM Elements (lazy init)
        // ============================================
        let stateLoading, stateSuccess, stateError;
        let errorMessage, errorDetail, errorDetailText;
        let successHint, closeBtn;

        function initDomElements() {
            stateLoading = document.getElementById('state-loading');
            stateSuccess = document.getElementById('state-success');
            stateError = document.getElementById('state-error');
            errorMessage = document.getElementById('error-message');
            errorDetail = document.getElementById('error-detail');
            errorDetailText = document.getElementById('error-detail-text');
            successHint = document.getElementById('success-hint');
            closeBtn = document.getElementById('close-btn');
        }

        // ============================================
        // UI State Management
        // ============================================

        function showState(state) {
            stateLoading.classList.toggle('state-hidden', state !== 'loading');
            stateSuccess.classList.toggle('state-hidden', state !== 'success');
            stateError.classList.toggle('state-hidden', state !== 'error');

            // Update document title
            if (state === 'success') {
                document.title = `驗證成功 - ${CONFIG.appName}`;
            } else if (state === 'error') {
                document.title = `驗證失敗 - ${CONFIG.appName}`;
            }
        }

        function showError(message, detail = null) {
            errorMessage.textContent = message;
            if (detail) {
                errorDetailText.textContent = detail;
                errorDetail.classList.remove('state-hidden');
            } else {
                errorDetail.classList.add('state-hidden');
            }
            showState('error');
        }

        function showSuccess() {
            showState('success');
            checkLiffAndSetupClose();
        }

        // ============================================
        // LIFF Close Behavior
        // ============================================

        async function checkLiffAndSetupClose() {
            const liffCheckTimeout = 1500; // 1.5 seconds max wait

            try {
                if (liffInitPromise) {
                    await Promise.race([
                        liffInitPromise,
                        new Promise(resolve => setTimeout(() => resolve(false), liffCheckTimeout))
                    ]);
                }
            } catch (e) {
                console.warn('LIFF check error (ignored):', e.message);
            }

            // Check if LIFF is ready and we're in LINE client
            const canAutoClose = isLiffReady &&
                                 typeof liff !== 'undefined' &&
                                 typeof liff.isInClient === 'function' &&
                                 liff.isInClient();

            if (canAutoClose) {
                // LIFF is ready - auto close after delay
                successHint.textContent = '視窗即將自動關閉...';
                successHint.classList.remove('state-hidden');
                closeBtn.classList.add('state-hidden');

                setTimeout(() => {
                    closeWindow();
                }, CONFIG.closeDelayMs);
            } else {
                // LIFF not available - show manual close button
                successHint.textContent = '驗證已完成';
                closeBtn.classList.remove('state-hidden');
            }
        }

        function closeWindow() {
            try {
                if (isLiffReady && typeof liff !== 'undefined' && liff.isInClient && liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.close();
                }
            } catch (e) {
                console.warn('Close window error:', e);
                window.close();
            }
        }

        // ============================================
        // Token Extraction
        // ============================================

        function getTokenFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }

        function getAppFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('app') || CONFIG.appContext;
        }

        // ============================================
        // API Communication
        // ============================================

        async function verifyToken(token) {
            const response = await fetch(CONFIG.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify({ token: token })
            });

            const data = await response.json();

            if (!response.ok) {
                const error = new Error(data.detail || data.message || `HTTP ${response.status}`);
                error.httpStatus = response.status;
                throw error;
            }

            return data;
        }

        // ============================================
        // LIFF Initialization (Background)
        // ============================================

        async function initializeLiffBackground() {
            try {
                const liffId = CONFIG.liffId;

                if (!liffId || liffId === '{{LIFF_ID}}') {
                    console.info('LIFF ID not configured, auto-close will be unavailable');
                    isLiffReady = false;
                    return;
                }

                await liff.init({ liffId });
                isLiffReady = true;
                console.info('LIFF initialized successfully (background)');
            } catch (error) {
                // LIFF error is a SOFT ERROR - never affects UI
                isLiffReady = false;
                console.info('LIFF init failed (soft error, ignored):', error.message);
            }
        }

        // ============================================
        // Error Parsing
        // ============================================

        function parseVerificationError(error) {
            let userMessage = '驗證過程發生錯誤，請重試';
            let technicalDetail = error.message;

            const msg = (error.message || '').toLowerCase();

            if (msg.includes('expired') || msg.includes('過期')) {
                userMessage = '驗證連結已過期';
                technicalDetail = '請重新申請驗證';
            } else if (msg.includes('invalid') || msg.includes('not found') || msg.includes('已使用') || msg.includes('used')) {
                userMessage = '驗證連結無效';
                technicalDetail = '連結可能已被使用或不存在';
            } else if (msg.includes('fetch') || msg.includes('network') || msg.includes('failed to fetch')) {
                userMessage = '網路連線錯誤';
                technicalDetail = '請檢查網路連線後重試';
            } else if (error.httpStatus >= 500) {
                userMessage = '伺服器暫時無法處理請求';
                technicalDetail = '請稍後再試';
            }

            return { userMessage, technicalDetail };
        }

        // ============================================
        // Main Entry Point
        // ============================================

        async function main() {
            // ========== Execution Guard ==========
            if (window.hasRun) {
                console.warn('Duplicate main() call blocked');
                return;
            }
            window.hasRun = true;

            // ========== Initialize DOM Elements ==========
            initDomElements();

            // ========== Ensure Loading State ==========
            showState('loading');

            // ========== Step 1: Extract Token SYNCHRONOUSLY ==========
            const token = getTokenFromUrl();
            console.info('Token extracted:', token ? 'present' : 'missing');

            // ========== Step 2: Validate Token Exists ==========
            if (!token) {
                showError('驗證連結無效', '缺少驗證碼參數');
                return;
            }

            // ========== Step 3: Start LIFF in Background ==========
            liffInitPromise = initializeLiffBackground();

            // ========== Step 4: Execute API Verification ==========
            try {
                await verifyToken(token);
                showSuccess();
            } catch (error) {
                console.error('Verification API error:', error);
                const { userMessage, technicalDetail } = parseVerificationError(error);
                showError(userMessage, technicalDetail);
            }
        }

        // ============================================
        // Bootstrap
        // ============================================

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', main, { once: true });
        } else {
            main();
        }
    </script>

</body>

</html>
