<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>身份驗證 - {{APP_NAME}}</title>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        /* Design Tokens from Leave Form */
        :root {
            --primary: #1A1A2E;
            --primary-light: #16213E;
            --accent: #06C755;
            --accent-hover: #05B34C;
            --danger: #E74C3C;
            --warning: #F39C12;
            --text: #333333;
            --text-light: #666666;
            --text-muted: #999999;
            --bg: #F5F7FA;
            --card-bg: #FFFFFF;
            --border: #E0E0E0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --radius: 16px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 24px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-logo {
            width: 60px;
            height: auto;
            margin-bottom: 12px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 0.875rem;
            opacity: 0.8;
            letter-spacing: 0.5px;
        }

        /* Main Layout */
        .main-content {
            flex: 1;
            padding: 20px;
            max-width: 480px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* Center Vertically */
        }

        /* Card */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 32px 24px;
            width: 100%;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 24px;
            text-align: center;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            color: var(--text);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.1);
        }

        /* Buttons */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 199, 85, 0.2);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            background: var(--border);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Alerts */
        .alert {
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            font-size: 0.95rem;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid var(--accent);
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid var(--danger);
        }

        /* Utilities */
        .state-hidden {
            display: none !important;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner-large {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        /* Loading Container */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="header">
        <img src="/static/crown.png?v=2" alt="Logo" class="header-logo" onerror="this.style.display='none'">
        <h1>身份驗證</h1>
        <p>Identity Verification</p>
    </header>

    <div class="main-content">

        <div class="card">

            <!-- Loading State -->
            <div id="state-loading" class="loading-container">
                <div class="spinner spinner-large"></div>
                <p style="margin-top: 16px; color: var(--text-light);">系統初始化中...</p>
            </div>

            <!-- Error State -->
            <div id="state-error" class="loading-container state-hidden">
                <div style="font-size: 3rem; margin-bottom: 16px;">⚠️</div>
                <h3 style="margin-bottom: 8px; color: var(--danger);">發生錯誤</h3>
                <p id="error-message" style="color: var(--text-light); margin-bottom: 24px; text-align: center;">無法連線
                </p>
                <button onclick="window.location.reload()" class="btn-primary"
                    style="background: var(--text-light); width: auto; padding: 10px 24px;">
                    重新整理
                </button>
            </div>

            <!-- Form State -->
            <div id="state-form" class="state-hidden">

                <h2 class="card-title">請輸入公司信箱</h2>

                <!-- Success Alert -->
                <div id="alert-success" class="alert alert-success state-hidden">
                    <div style="font-size: 1.2rem;">✅</div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">驗證連結已發送</div>
                        <div id="success-email" style="font-size: 0.9rem;">請檢查您的信箱</div>
                    </div>
                </div>

                <!-- Error Alert -->
                <div id="alert-error" class="alert alert-error state-hidden">
                    <div style="font-size: 1.2rem;">⚠️</div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">錯誤</div>
                        <div id="form-error-message"></div>
                    </div>
                </div>

                <!-- Form -->
                <form id="email-form">
                    <input type="hidden" id="line_sub" name="line_sub">
                    <input type="hidden" id="line_id_token" name="line_id_token">
                    <input type="hidden" id="app_context" name="app_context" value="{{APP_CONTEXT}}">

                    <div class="form-group">
                        <label for="email" class="form-label">電子郵件 / Email</label>
                        <input type="email" id="email" name="email" class="form-input"
                            placeholder="your.name@company.com" required>
                    </div>

                    <button type="submit" id="submit-btn" class="btn-primary">
                        <span id="submit-text">發送驗證連結</span>
                        <span id="submit-loading" class="state-hidden"
                            style="display: flex; align-items: center; gap: 8px;">
                            <span class="spinner"></span> 處理中...
                        </span>
                    </button>
                </form>

                <!-- User Info -->
                <div class="user-info"
                    style="margin-top: 24px; padding-top: 24px; border-top: 1px dashed var(--border);">
                    <div
                        style="display: flex; align-items: center; justify-content: center; gap: 10px; color: var(--text-light); font-size: 0.9rem;">
                        <span>目前登入：</span>
                        <span id="line-display-name" style="color: var(--primary); font-weight: 500;">-</span>
                    </div>
                </div>

            </div>

        </div>

        <div class="footer">
            連結有效期限 {{EXPIRE_MINUTES}} 分鐘 • {{APP_NAME}}
        </div>

    </div>

    <!-- Script Logic (Preserved exactly as is) -->
    <script>
        /**
         * Framework-First Authentication - Login Page
         * 
         * Flow:
         * 1. Initialize LIFF SDK with injected LIFF ID
         * 2. Get user profile and ID token from LINE
         * 3. User enters company email
         * 4. POST to /auth/request-magic-link with email, id_token, app_context
         * 5. Backend sends magic link email
         */

        // ============================================
        // Configuration (Injected by Backend)
        // ============================================
        const CONFIG = {
            liffId: '{{LIFF_ID}}',
            appContext: '{{APP_CONTEXT}}',
            appName: '{{APP_NAME}}',
            apiEndpoint: '/auth/request-magic-link'
        };

        // ============================================
        // DOM Elements
        // ============================================
        const stateLoading = document.getElementById('state-loading');
        const stateError = document.getElementById('state-error');
        const stateForm = document.getElementById('state-form');
        const errorMessage = document.getElementById('error-message');
        const emailForm = document.getElementById('email-form');
        const alertSuccess = document.getElementById('alert-success');
        const alertError = document.getElementById('alert-error');
        const formErrorMessage = document.getElementById('form-error-message');
        const successEmail = document.getElementById('success-email');
        const lineDisplayName = document.getElementById('line-display-name');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitLoading = document.getElementById('submit-loading');

        // ============================================
        // State Management
        // ============================================

        function showState(state) {
            stateLoading.classList.toggle('state-hidden', state !== 'loading');
            stateError.classList.toggle('state-hidden', state !== 'error');
            stateForm.classList.toggle('state-hidden', state !== 'form');
        }

        function showFormError(message) {
            alertError.classList.remove('state-hidden');
            alertSuccess.classList.add('state-hidden');
            formErrorMessage.textContent = message;
        }

        function showFormSuccess(email) {
            alertSuccess.classList.remove('state-hidden');
            alertError.classList.add('state-hidden');
            successEmail.textContent = `請檢查 ${email} 的信箱`;
            // Hide button to prevent double submit
            submitBtn.style.display = 'none';
        }

        function showInitError(message) {
            errorMessage.textContent = message;
            showState('error');
        }

        function setSubmitLoading(loading) {
            submitBtn.disabled = loading;
            submitText.classList.toggle('state-hidden', loading);
            submitLoading.classList.toggle('state-hidden', !loading);
        }

        // ============================================
        // LIFF Initialization
        // ============================================

        async function initializeLiff() {
            // console.log('Using LIFF ID:', CONFIG.liffId); // Debug

            // Validate LIFF ID
            const liffId = CONFIG.liffId ? CONFIG.liffId.trim() : '';
            const isPlaceholder = liffId.includes('{{') || liffId.includes('}}');

            if (!liffId || isPlaceholder) {
                showInitError('LIFF ID 未設定，請聯繫管理員');
                return;
            }

            if (typeof liff === 'undefined') {
                showInitError('無法載入 LINE SDK');
                return;
            }

            try {
                await liff.init({ liffId: CONFIG.liffId });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                lineDisplayName.textContent = profile.displayName;

                const idToken = liff.getIDToken();
                if (!idToken) {
                    showInitError('無法取得 LINE ID Token');
                    return;
                }

                // Decode ID token
                const tokenPayload = parseJwt(idToken);
                const lineSub = tokenPayload?.sub || '';

                // Populate hidden fields
                document.getElementById('line_sub').value = lineSub;
                document.getElementById('line_id_token').value = idToken;

                showState('form');

            } catch (error) {
                console.error('LIFF init failed:', error);
                showInitError(`系統初始化失敗: ${error.message}`);
            }
        }

        /**
         * Parse JWT token payload
         */
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(
                    atob(base64).split('').map(c =>
                        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                    ).join('')
                );
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        // ============================================
        // Form Submission
        // ============================================

        async function handleFormSubmit(event) {
            event.preventDefault();

            alertSuccess.classList.add('state-hidden');
            alertError.classList.add('state-hidden');

            const email = document.getElementById('email').value.trim().toLowerCase();
            const lineSub = document.getElementById('line_sub').value;
            const lineIdToken = document.getElementById('line_id_token').value;
            const appContext = document.getElementById('app_context').value;

            if (!email) {
                showFormError('請輸入電子郵件');
                return;
            }

            // Simple email validation
            if (!email.includes('@') || !email.includes('.')) {
                showFormError('請輸入有效的電子郵件格式');
                return;
            }

            if (!lineSub) {
                showFormError('LINE 身份驗證過期，請重新整理');
                return;
            }

            setSubmitLoading(true);

            try {
                const response = await fetch(CONFIG.apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        email: email,
                        line_sub: lineSub,
                        line_id_token: lineIdToken,
                        app_context: appContext
                    })
                });

                const contentType = response.headers.get('content-type');

                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (response.ok) {
                        showFormSuccess(email);
                    } else {
                        showFormError(data.detail || data.message || '發送失敗');
                    }
                } else {
                    if (response.ok) {
                        showFormSuccess(email);
                    } else {
                        showFormError('伺服器回應錯誤');
                    }
                }

            } catch (error) {
                console.error('Submit error:', error);
                showFormError('連線發生錯誤，請稍後再試');
            } finally {
                setSubmitLoading(false);
            }
        }

        // ============================================
        // Bootstrap
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            emailForm.addEventListener('submit', handleFormSubmit);
            initializeLiff();
        });
    </script>

</body>

</html>